name: Publish to NPM

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Extract version from tag
        id: extract_version
        run: |
          # ä»Gitæ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰vå‰ç¼€ï¼‰
          if [[ "${{ github.ref_name }}" =~ ^v(.+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "ç‰ˆæœ¬å·: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ— æ•ˆçš„æ ‡ç­¾æ ¼å¼: ${{ github.ref_name }}"
            echo "æ ‡ç­¾åº”è¯¥ä»¥ 'v' å¼€å¤´ï¼Œä¾‹å¦‚: v1.0.2"
            exit 1
          fi

      - name: Update package.json version
        run: |
          # è·å–å½“å‰package.jsonä¸­çš„ç‰ˆæœ¬
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          NEW_VERSION="${{ steps.extract_version.outputs.version }}"
          
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"
          
          # ä½¿ç”¨npm versionå‘½ä»¤æ›´æ–°ç‰ˆæœ¬å·ï¼ˆä¸åˆ›å»ºgit tagï¼‰
          npm version $NEW_VERSION --no-git-tag-version
          
          echo "âœ… package.jsonç‰ˆæœ¬å·²æ›´æ–°ä¸º: $NEW_VERSION"

      - name: Update source code version
        run: |
          NEW_VERSION="${{ steps.extract_version.outputs.version }}"
          
          # æ›´æ–°src/index.tsä¸­çš„ç‰ˆæœ¬å·
          sed -i "s/wxcloud-mcp v[0-9]\+\.[0-9]\+\.[0-9]\+/wxcloud-mcp v$NEW_VERSION/g" src/index.ts
          
          echo "âœ… æºä»£ç ç‰ˆæœ¬å·å·²æ›´æ–°"

      - name: Verify NPM Token
        run: |
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "âŒ NPM_TOKEN secret is not set!"
            echo "Please add NPM_TOKEN to GitHub repository secrets."
            echo "Visit: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          else
            echo "âœ… NPM_TOKEN is available"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run tests (if available)
        run: npm test || echo "No tests found"

      - name: Check npm authentication
        run: |
          echo "Checking npm authentication..."
          npm whoami || echo "Not authenticated yet"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify final package
        run: |
          echo "ğŸ“¦ æœ€ç»ˆåŒ…ä¿¡æ¯:"
          echo "åç§°: $(node -p "require('./package.json').name")"
          echo "ç‰ˆæœ¬: $(node -p "require('./package.json').version")"
          echo "æ ‡ç­¾: ${{ github.ref_name }}"
          
          # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦åŒ¹é…
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${{ steps.extract_version.outputs.version }}"
          
          if [ "$PACKAGE_VERSION" = "$TAG_VERSION" ]; then
            echo "âœ… ç‰ˆæœ¬å·åŒ¹é…ï¼Œå‡†å¤‡å‘å¸ƒ"
          else
            echo "âŒ ç‰ˆæœ¬å·ä¸åŒ¹é…: package.json($PACKAGE_VERSION) vs tag($TAG_VERSION)"
            exit 1
          fi

      - name: Publish to NPM
        run: |
          echo "ğŸš€ å‘å¸ƒåŒ…åˆ°NPM..."
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: actions/create-release@v1
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ğŸš€ **wxcloud-mcp ${{ github.ref_name }}**
            
            è‡ªåŠ¨å‘å¸ƒåˆ° NPM: https://www.npmjs.com/package/wxcloud-mcp
            
            **å®‰è£…æ–¹å¼:**
            ```bash
            npm install -g wxcloud-mcp@${{ steps.extract_version.outputs.version }}
            ```
            
            **ç‰ˆæœ¬ä¿¡æ¯:**
            - ç‰ˆæœ¬å·: ${{ steps.extract_version.outputs.version }}
            - å‘å¸ƒæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - æäº¤SHA: ${{ github.sha }}
            
            **ä¸»è¦åŠŸèƒ½:**
            - âœ… ESæ¨¡å—æ”¯æŒ
            - âœ… å¾®ä¿¡äº‘å¼€å‘CLIé›†æˆ
            - âœ… MCPåè®®æ”¯æŒ
            - âœ… 9ä¸ªäº‘å¼€å‘å·¥å…·
            
            **ä½¿ç”¨æ–¹æ³•:**
            1. å®‰è£…: `npm install -g wxcloud-mcp`
            2. åœ¨MCPå®¢æˆ·ç«¯ä¸­é…ç½®
            3. äº«å—å¾®ä¿¡äº‘å¼€å‘è‡ªåŠ¨åŒ–ï¼
            
            **æ›´å¤šä¿¡æ¯:** https://github.com/iptton-ai/wxcloud-mcp
          draft: false
          prerelease: false

      - name: Commit version update (optional)
        if: success()
        run: |
          # å¯é€‰ï¼šå°†ç‰ˆæœ¬æ›´æ–°æäº¤å›ä»“åº“
          # è¿™æ ·ä»“åº“ä¸­çš„ç‰ˆæœ¬å·ä¼šä¿æŒæœ€æ–°
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git add package.json src/index.ts
            git commit -m "chore: bump version to ${{ steps.extract_version.outputs.version }} [skip ci]"
            git push origin HEAD:main
            echo "âœ… ç‰ˆæœ¬æ›´æ–°å·²æäº¤å›ä»“åº“"
          fi
